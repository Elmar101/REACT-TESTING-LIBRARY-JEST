# Async TestlÉ™r (Jest + React Testing Library)

Async (asinxron) testlÉ™r â€” nÉ™ticÉ™si dÉ™rhal gÉ™lmÉ™yÉ™n ÅŸeylÉ™ri test etmÉ™k Ã¼Ã§Ã¼ndÃ¼r.
MÉ™sÉ™lÉ™n:
- `fetch/axios` ilÉ™ API Ã§aÄŸÄ±rÄ±ÅŸÄ±
- `setTimeout / setInterval`
- komponent render olandan sonra gÉ™lÉ™n data
- klikdÉ™n sonra state yenilÉ™nmÉ™si vÉ™ UI-nin gec dÉ™yiÅŸmÉ™si
- debounce / throttle kimi gecikmÉ™lÉ™r

Asaqida async testlÉ™rin É™n praktik hissÉ™lÉ™rini â€œnÉ™ vaxt nÉ™yi iÅŸlÉ™tmÉ™liâ€ mÉ™ntiqi ilÉ™ izah edirÉ™m.

---

## 1) Æsas ideya: â€œGÃ¶rÃ¼nÉ™n UI gec gÉ™lirsÉ™, test dÉ™ gÃ¶zlÉ™mÉ™lidirâ€

React-da Ã§ox vaxt bu ssenari olur:

1. Komponent render olur â†’ â€œLoading...â€ gÃ¶rÃ¼nÃ¼r  
2. API cavabÄ± gÉ™lir â†’ â€œUsersâ€ siyahÄ±sÄ± gÃ¶rÃ¼nÃ¼r

DemÉ™li test:
- É™vvÉ™l â€œLoading...â€ var mÄ±? yoxlaya bilÉ™r
- sonra nÉ™ticÉ™ gÉ™lÉ™nÉ™dÉ™k **gÃ¶zlÉ™yib** yeni UI-ni yoxlamalÄ±dÄ±r

---

## 2) Jest-dÉ™ async test yazma Ã¼sullarÄ±

### 2.1 `async/await` (É™n standart yol)

```js
test("async iÅŸ gÃ¶rÃ¼r", async () => {
  const result = await Promise.resolve(42);
  expect(result).toBe(42);
});

test("promise qaytarmaq", () => {
  return Promise.resolve("ok").then((v) => {
    expect(v).toBe("ok");
  });
});

2.3 done callback (Ã§ox nadir, kÃ¶hnÉ™ Ã¼slub)
Bunu adÉ™tÉ™n istifadÉ™ etmÉ™, amma bilmÉ™k faydalÄ±dÄ±r.

test("done ilÉ™", (done) => {
  setTimeout(() => {
    expect(true).toBe(true);
    done();
  }, 10);
});

3) RTL-dÉ™ async: findBy* vÉ™ waitFor É™sas silahlardÄ±r
3.1 findBy* nÉ™dir?

findBy* â€” elementin DOM-da gÃ¶rÃ¼nmÉ™sini gÃ¶zlÉ™yir.
ÆgÉ™r element mÃ¼É™yyÉ™n mÃ¼ddÉ™tdÉ™ tapÄ±lmasa test fail olur.

getBy* â†’ dÉ™rhal tapmalÄ±dÄ±r, tapmasa fail

queryBy* â†’ tapmasa null qaytarÄ±r, fail etmir

findBy* â†’ gÃ¶zlÉ™yir, sonra tapÄ±r (async) => NÃ¼munÉ™: API nÉ™ticÉ™si gÉ™lib text gÃ¶rÃ¼nÃ¼r

import { render, screen } from "@testing-library/react";

test("istifadÉ™Ã§ilÉ™r yÃ¼klÉ™nÉ™ndÉ™n sonra gÃ¶rÃ¼nÃ¼r", async () => {
  render(<UsersPage />);

  // nÉ™ticÉ™ gec gÉ™lir deyÉ™ findBy istifadÉ™ edirik
  const title = await screen.findByText(/users/i);
  expect(title).toBeInTheDocument();
});

ðŸ“Œ QÄ±zÄ±l qayda:
UI element â€œsonradanâ€ yaranÄ±rsa, findBy* Ã§ox vaxt É™n doÄŸru seÃ§imdir.

3.2 waitFor nÉ™dir?
waitFor â€” sÉ™nin yazdÄ±ÄŸÄ±n expect(lÉ™rin) doÄŸru olana qÉ™dÉ™r tÉ™krar yoxlayÄ±r.

Bunu adÉ™tÉ™n: bir neÃ§É™ dÉ™yiÅŸiklik ard-arda olursa, element Ã§Ä±xmalÄ± / itmeli olursa , xÃ¼susi ÅŸÉ™rt gÃ¶zlÉ™yirsÉ™nsÉ™

import { render, screen, waitFor } from "@testing-library/react";

test("loading gedir, data gÉ™lir", async () => {
  render(<UsersPage />);

  // É™vvÉ™l loading var
  expect(screen.getByText(/loading/i)).toBeInTheDocument();

  // sonra loading yox olmalÄ±dÄ±r
  await waitFor(() => {
    expect(screen.queryByText(/loading/i)).not.toBeInTheDocument();
  });

  // sonra data gÃ¶rÃ¼nÃ¼r
  expect(screen.getByText(/users/i)).toBeInTheDocument();
});

ðŸ“Œ QÄ±zÄ±l qayda:
â€œBir ÅŸey yox olmalÄ±dÄ±râ€ vÉ™ ya â€œÅŸÉ™rtli dÉ™yiÅŸiklikâ€ Ã¼Ã§Ã¼n waitFor Ã§ox uyÄŸundur.

4) userEvent async ola bilÉ™r â€” unutma!
userEvent real istifadÉ™Ã§i davranÄ±ÅŸÄ±na daha yaxÄ±ndÄ±r vÉ™ bÉ™zi action-lar async olur.
Ona gÃ¶rÉ™ Ã§ox vaxt await yazÄ±lÄ±r.

import userEvent from "@testing-library/user-event";

test("button klikdÉ™n sonra text dÉ™yiÅŸir", async () => {
  const user = userEvent();
  render(<Counter />);

  await user.click(screen.getByRole("button", { name: /increment/i }));

  expect(screen.getByText("1")).toBeInTheDocument();
});
ðŸ“Œ ÆgÉ™r userEvent() istifadÉ™ edirsÉ™nsÉ™, Ã§ox hallarda action-larÄ± await et.

5) Async API Ã§aÄŸÄ±rÄ±ÅŸlarÄ±nÄ± mock etmÉ™k (É™n praktik yol)
Æn rahat Ã¼sul: jest.mock(...) ilÉ™ API modulunu mock etmÉ™k.

5.1 API modul nÃ¼munÉ™si
// api.js
export async function getUsers() {
  const res = await fetch("/users");
  return res.json();
}

import { render, screen } from "@testing-library/react";
import { getUsers } from "./api";
import UsersPage from "./UsersPage";

jest.mock("./api");

test("API-dÉ™n gÉ™lÉ™n user-lÉ™r gÃ¶rÃ¼nÃ¼r", async () => {
  getUsers.mockResolvedValue([{ id: 1, name: "Aysel" }]);

  render(<UsersPage />);
  const findedUserName = await screen.findByText("Aysel");
  expect(findedUserName).toBeInTheDocument();
});
ðŸ“Œ Burada:
mockResolvedValue â†’ promise-Ä±n uÄŸurla nÉ™ticÉ™ qaytarmasÄ±nÄ± simulyasiya edir
findByText â†’ nÉ™ticÉ™ UI-dÉ™ gÃ¶rÃ¼nÉ™nÉ™ qÉ™dÉ™r gÃ¶zlÉ™yir

6) SÉ™hv (error) ssenarisini test etmÉ™k
test("error olanda mesaj Ã§Ä±xÄ±r", async () => {
  getUsers.mockRejectedValue(new Error("Network error"));

  render(<UsersPage />);

  expect(await screen.findByText(/something went wrong/i)).toBeInTheDocument();
});

7) Fake Timers: setTimeout / debounce testlÉ™ri
ÆgÉ™r kodun setTimeout ilÉ™ iÅŸlÉ™yirsÉ™, Jest timer-larÄ± idarÉ™ edÉ™ bilÉ™r.
jest.useFakeTimers();

test("timeoutdan sonra iÅŸlÉ™yir", () => {
  const fn = jest.fn();

  setTimeout(fn, 1000);

  // hÉ™lÉ™ Ã§aÄŸrÄ±lmamalÄ±dÄ±r
  expect(fn).not.toHaveBeenCalled();

  // zamanÄ± irÉ™li aparÄ±rÄ±q
  jest.advanceTimersByTime(1000);

  expect(fn).toHaveBeenCalledTimes(1);
});
ðŸ“Œ Qeyd:

UI testlÉ™rindÉ™ fake timers bÉ™zÉ™n RTL ilÉ™ konflikt yarada bilÉ™r.

Debounce/timeout logic testlÉ™rindÉ™ daha uyÄŸundur.

8) Æn Ã§ox edilÉ™n sÉ™hvlÉ™r (vÉ™ dÃ¼zÉ™liÅŸlÉ™r)
âŒ SÉ™hv: getBy* ilÉ™ async elementi axtarmaq
// element gec gÉ™lir, bu dÉ™rhal fail ola bilÉ™r
screen.getByText("Aysel");
âœ… DÃ¼z: findBy*

await screen.findByText("Aysel");
âŒ SÉ™hv: waitFor iÃ§indÉ™ getBy*-Ä± sÉ™hv qurmaq
waitFor iÃ§indÉ™ istifadÉ™ edÉ™ndÉ™, Ã¼mumÉ™n expect-in Ã¶zÃ¼ ÅŸÉ™rt olmalÄ±dÄ±r.

âœ… DÃ¼z nÃ¼munÉ™:
await waitFor(() => {
  expect(screen.getByText("Done")).toBeInTheDocument();
});

âŒ SÉ™hv: Loading-in getmÉ™sini getByText ilÉ™ yoxlamaq
getByText tapmayanda fail edir.

âœ… DÃ¼z: queryByText
expect(screen.queryByText(/loading/i)).not.toBeInTheDocument();

9) Cheat Sheet (tez baxÄ±ÅŸ)
Element dÉ™rhal olmalÄ±dÄ±r â†’ getBy*
Element olmaya da bilÉ™r â†’ queryBy*
Element gec gÉ™lÉ™cÉ™k â†’ findBy*
ÅžÉ™rtli dÉ™yiÅŸiklik / yox olma / bir neÃ§É™ addÄ±m â†’ waitFor

Real user davranÄ±ÅŸÄ± â†’ userEvent (Ã§ox vaxt await)

10) Mini nÃ¼munÉ™: Tam ssenari
test("flow: loading -> data", async () => {
  getUsers.mockResolvedValue([{ id: 1, name: "Aysel" }]);

  render(<UsersPage />);

  expect(screen.getByText(/loading/i)).toBeInTheDocument();

  expect(await screen.findByText("Aysel")).toBeInTheDocument();

  await waitFor(() => {
    expect(screen.queryByText(/loading/i)).not.toBeInTheDocument();
  });
});